#!/usr/bin/perl -I /ebay/gauntlet/lib

# Tool for updating gauntlet host data
# Copyright (c) 2011 Adam Beeman and eBay, Inc.


use DBI;
use Getopt::Std;
use File::Basename;
use GauntletConfig;
use CGI qw(:standard);


# database information
$connectionInfo="DBI:mysql:database=$gdb;$gdhost:3306";

unless (param("job")) {
  print "$usage\n";
  exit 1;
}


# successful audits
# select count(*) from tasks where status = 'completed' and audit = 'read-only-root-fs'
my $outfile = "$gauntlet_base/html/csv/job-" . param("job") . ".csv";

#print "Content-type: text/plain\r\n\r\n";

if (! -e $outfile) {
	$dbh=DBI->connect($connectionInfo,$gdbuser,$gdbpass);
	$sql="select 'Hostname', 'Domain', 'Audit', 'Status', 'Result' union" .
	 	"(select hostname, domain, audit, status, result from tasks where jobid = \? order by status desc" .
	 	" INTO OUTFILE '$outfile' " .
		"FIELDS TERMINATED BY ',' ENCLOSED BY '\"' ESCAPED BY '\"' LINES TERMINATED BY '\r\n')";
	$sth=$dbh->prepare($sql);
	$sth->execute(param("job"));
	$dbh->disconnect();
}


#while ( my $row = $sth->fetchrow_arrayref ) {
#	print join( ",", @$row ), "\n";
#}

#$dbh->disconnect();

#print "Content-type: text/csv\r\n\r\n";
#print `cat $outfile`;

print "Location: /gauntlet/csv/job-" . param("job") . ".csv\n\n";

